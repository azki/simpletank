<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
	<head>
		<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
		<title>Simple Tank : tank.azki.org</title>
		<style type="text/css">		
			html, body {
			    margin: 0
			}
			
			#cvmap {
		    	background: -moz-linear-gradient(top, #040429, #257eb7);
    			background:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#040429), color-stop(100%,#257eb7));
			}
			
			#message {
				top: 20px;
				background: #2F2933;
				opacity: 0.8;
				padding: 10px 20px;
				text-align: center;
				border-radius: 10px;
				font-weight: bold;
				color: #fff;
			}
			#message b {
				font-size: xx-large;
				color: #FFFFA6;
			}
			.user {
				background:rgba(54,57,66,0.75);
			}
			.user .nick {
				font-size:22pt;
				font-weight:bold;
				color:#fff;
			}
			.user .ready {
				margin:30px 10px 10px 0;
				text-align:right;
				font-size:28pt;
				color:#D8CAA8;
			}
			
		</style>
		<link rel="stylesheet" href="./css/animate-wind.css"/>
		<link rel="stylesheet" href="./css/animate-custom.css"/>
		<script type="text/javascript" src="./js/jquery-1.4.1.min.js">
		</script>
		<!--[if IE]>
			<script type="text/javascript" src="./js/excanvas.compiled.js"></script>
		<![endif]-->
		<script type="text/javascript">
			var simpleTank = {};
		</script>
		<script type="text/javascript" src="./js/map.js">
		</script>
		<script type="text/javascript" src="./js/tanks.js">
		</script>
		<script type="text/javascript" src="./js/tank.js">
		</script>
		<script type="text/javascript" src="./js/shot.js">
		</script>
		<script type="text/javascript" src="./js/player.js">
		</script>
		<script type="text/javascript" src="./js/Ai04.js">
		</script>
		<script type="text/javascript" src="./js/io.min.js">
		</script>
		<script type="text/javascript" src="./js/ui.js">
		</script>
		<script type="text/javascript">
/*global $,simpleTank,io4azki*/
/*global ROOM_LIMIT*/
"use strict";
var ROOM_LIMIT = 4;
var map, tanks, shot;
$(function() {
	var mapWidth, mapHeight, i, cvmap, cvtank, cvshot, mapCtx, tankCtx, shotCtx;
	mapWidth = innerWidth;
	mapHeight = innerHeight;
	$("#canvasPanel").width(mapWidth).height(mapHeight);
	$("#canvasPanel>canvas").attr("width", mapWidth).attr("height", mapHeight);
	cvmap = $("#cvmap").get(0);
	cvtank = $("#cvtank").get(0);
	cvshot = $("#cvshot").get(0);
	if (cvmap.getContext) {
		mapCtx = cvmap.getContext("2d");
		tankCtx = cvtank.getContext("2d");
		shotCtx = cvshot.getContext("2d");
		map = new simpleTank.Map(mapCtx, {
			width: mapWidth,
			height: mapHeight
		});
		tanks = new simpleTank.Tanks(tankCtx, {
			map: map
		});
		shot = new simpleTank.Shot(shotCtx, {
			map: map,
			tanks: tanks
		});
		map.newMapData();
		map.redraw();
		
		startFirstGame();
	} else {
		$("#canvasPanel").html("<h1>Canvas를 지원하지 않는 브라우저입니다.</h1>");
	}
});

function startFirstGame() {
	var player, ui;
	player = new simpleTank.Player([{
		type: "user",
		color: "#f00",
		name: "유저1",
		team: 1
	}, {
		type: "Ai04",
		difficulty: 1,
		color: "#00f",
		name: "컴퓨터1",
		team: 2
	}, {
		type: "Ai04",
		difficulty: 3,
		color: "#ff0",
		name: "컴퓨터2",
		team: 3
	}, {
		type: "Ai04",
		difficulty: 9,
		color: "#f0f",
		name: "컴퓨터3",
		team: 4
	}]);
	ui = new simpleTank.Ui(map, tanks, shot, player, function(result) {
		if (result.type === "turnLost") {
			setTimeout(function() {
				map.newMapData();
				map.redraw();
				ui.newGame(player);
				ui.nextPlayer();
			}, 3000);
		}
	});
	window.tankUi = ui;
	ui.onNewTurn = function () {
		console.log("onNewTurn", arguments);
	};
	ui.nextPlayer();
	initSock();
}

function startGame() {
	//TODO player
}

function updateReadyRoomUser(users) {
	var i, len, user;
	len = users.length;
	for (i = 0; i < len; i += 1) {
		user = users[i];
		$("#user" + i + " .nick").text(user.nickName);
		$("#user" + i + " .ready").css("visibility", user.ready ? "" : "hidden");
	}
	while (i < ROOM_LIMIT) {
		if (i === 0) {
			$("#user" + i + " .nick").text("[주인을 기다립니다.]");
			$("#user" + i + " .ready").css("visibility", "hidden");
		} else {
			$("#user" + i + " .nick").text("컴퓨터" + i);
			$("#user" + i + " .ready").css("visibility", "");
		}
		i += 1;
	}
	
	
	// TODO 빈 공간은 Ai 로 채우자.
}

var ROOM_NUM = 0;
function showRoomMessage() {
	$("#message")
	.html('<p>모바일에서<br/><b>http://azki.org:89/' + ROOM_NUM + '</b><br/>로 접속하세요.</p>')
	.css("display", "inline-block")
	.removeClass()
	.addClass("animated bounceInDown");
}
function hideRoomMessage() {
	$("#message").removeClass().addClass("animated bounceOutDown");
}
function showUserTable() {
	$("#userTable")
	.css("display", "inline-table")
	.removeClass()
	.addClass("animated bounceInDown");
}
function hideUserTable() {
	$("#userTable").removeClass().addClass("animated bounceOutDown");
}
function initSock() {
	var socket;
	socket = io4azki.connect("/tank");
	socket.on("connect", function() {
		socket.emit("createRoom", ROOM_LIMIT);
	});
	socket.on("disconnect", function() {
		hideRoomMessage();
		hideUserTable();
	});
	socket.on("newRoom", function(roomNum) {
		ROOM_NUM = roomNum;
		showRoomMessage();
		showUserTable();
		updateReadyRoomUser([]);
		//TODO Ai 끼리 연습게임 시작함..
	});
	socket.on("set_angle", function(data) {
		console.log("set_angle", data);
		tankUi.setAngle(data.tankIndex, data.value);
	});
	socket.on("set_power", function(data) {
		console.log("set_power", data);
		tankUi.setPower(data.tankIndex, data.value);
	});
	socket.on("set_fire", function(data) {
		console.log("set_fire", data);
		if (tankUi.getTurnIndex() === data.tankIndex) {
			tankUi.fire(data.value, function(){
				//TODO send nextTurn to server.
				console.log('TODO nextTurn');
			});
		}
	});
	socket.on("updateRoom", function(room) {
		console.log("updateRoom", room);
		updateReadyRoomUser(room.users);
		// TODO 모두 레디일 경우 5초 후 시작..
	});
}
		</script>
	</head>
	<body>
		<div id="canvasPanel" style="position:absolute;">
			<canvas id="cvmap" style="position:absolute;"/></canvas>
			<canvas id="cvtank" style="position:absolute;"></canvas>
			<canvas id="cvshot" style="position:absolute;"></canvas>
			<img id="pinWheel" src="img/pinwheel.png" style="position:absolute;top:10px;left:95px;"/>
		</div>
		<div style="position: absolute; width:100%; text-align:center;">
			<div id="message" style="position:relative; display:none;"></div>
			<br/>
			<table id="userTable" style="position: relative; display:none; margin-top:50px; width:80%;" border="1">
			<colgroup><col width="25%"/><col width="25%"/><col width="25%"/><col width="25%"/></colgroup>
			<tr>
				<td id="user0" class="user">
					<h1 style="color:#f00">빨간탱크</h1>
					<div class="nick"></div>
					<div class="ready">Ready</div>
				</td>
				<td id="user1" class="user">
					<h1 style="color:#00f">파란탱크</h1>
					<div class="nick"></div>
					<div class="ready">Ready</div>
				</td>
				<td id="user2" class="user">
					<h1 style="color:#ff0">노란탱크</h1>
					<div class="nick"></div>
					<div class="ready">Ready</div>
				</td>
				<td id="user3" class="user">
					<h1 style="color:#f0f">보라탱크</h1>
					<div class="nick"></div>
					<div class="ready">Ready</div>
				</td>
			</tr></table>
		</div>
		<div id="thisIsMyTurn" style="position:absolute; display:none;"></div>
	</body>
</html>
