<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>Simple Tank : tank.azki.org</title>
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
		<style type="text/css">
html,body {margin:0}
body { font-family:Georgia; }
#btns { padding:5px; text-align:center;}
</style>
		<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js"></script>
		<script src="./js/io.min.js"></script>
	</head>
	<body>
		<form onsubmit="return false;">
			<div id="status" class="ui-body ui-body-c">
				상태메시지
			</div>
			<div id="hp" class="ui-body ui-body-c">
				hp
			</div>
			<div id="angle" class="ui-body ui-body-c">
				angle<br/>
				<input type="range" name="angleSlider" id="angleSlider" value="45" min="1" max="179"  data-highlight="true" />
			</div>
			<div id="power" class="ui-body ui-body-c">
				power<br/>
				<input type="range" name="powerSlider" id="powerSlider" value="50" min="0" max="99"  data-highlight="true" />
			</div>
			<div id="btns" class="ui-body ui-body-c">
				<button id="move" type="button" data-inline="true">move</button>
				<button id="doubleShot" type="button" data-inline="true">double shot</button>
				<button id="shot" type="button" data-inline="true">normal shot</button>
			</div>
		</form>
		<script>
"use strict";
var ROOM_NUM = -1;
window.onload = function(){
	var clientUniq = localStorage.getItem("clientUniq");
	if (!clientUniq) {
		clientUniq = Math.random().toString(36).substr(2);
		localStorage.setItem("clientUniq", clientUniq);
	}
	
	var nickName = localStorage.getItem("nickName");
	while (!nickName) {
		nickName = prompt("닉네임을 입력하세요", "");
		localStorage.setItem("nickName", nickName);
	}
	
	(function() {
		var matched = location.href.match(/^\S+\/(\d+)$/);
		if (matched) {
			ROOM_NUM = +matched[1];
		}
	}());
	
	var isRoom = false;
	var isMyTurn = false; // TODO.
	var socket = io4azki.connect("/tank");
	socket.on("connect", function(){
		$("#status").html("접속 중입니다.");
		socket.emit("join", {
			clientUniq: clientUniq,
			nickName: nickName,
			roomNum: ROOM_NUM
		});
	});
	socket.on("disconnect", function(){
		$("#status").html("접속이 끊켰어요..");
		isRoom = false;
	});
	socket.on("okRoom", function(info){
		$("#status").html(info.roomNum + "번 방에 입장했어요!");
		isRoom = true;
	});
	socket.on("error", function(msg){
		$("#status").html("Error : " + msg);
		isRoom = false;
	});
	
	window.dd = socket;
	 
	function sendAngle() {
		if (isRoom) {
			socket.emit("tank", {
				name: "angle",
				value: Math.abs(180 - $("#angleSlider").val())
			});
		}
	}
	
	function sendPower() {
		if (isRoom) {
			socket.emit("tank", {
				name: "power",
				value: +$("#powerSlider").val()
			});
		}
	}
	
	function sendFire(fireType) {
		if (isRoom) {
			socket.emit("tank", {
				name: "fire",
				value: fireType
			});
		}
	}
	
	$("#angleSlider").change(sendAngle);
	$("#powerSlider").change(sendPower);
	$("#move,#doubleShot,#shot").click(function () {
		sendFire($(this).attr("id"));
	});
	
};
		</script>
	</body>
</html>