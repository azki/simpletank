<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>Simple Tank : tank.azki.org</title>
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
		<style type="text/css">
			html, body {
			    margin: 0
			}
			
			body {
			    font-family: Georgia;
			}
			
			.r-panel {
			    margin: 0;
			    text-align: center;
			}
			
			.r-panel h2 {
			    margin: 0 0 0 15px;
			    text-align: left;
			}
			
			#statusPanel {
				padding: 10px;
			}
			#status {
				font-size:larger;
				font-weight:bold;
			}
			
			#nickNamePanel label {
			    display: inline-block;
			}
			
			#nickName {
			    width: 40%;
			    display: inline-block;
			}
		</style>
		<script src="http://code.jquery.com/jquery-1.7.1.min.js">
		</script>
		<script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js">
		</script>
		<script src="./js/io.min.js">
		</script>
	</head>
	<body>
		<form onsubmit="return false;">
			<div id="statusPanel" class="r-panel ui-body-a">
				<span id="status">status</span>
			</div>
			<div id="nickNamePanel" class="r-panel ui-body-c" data-role="fieldcontain">
				<label for="nickName">
					nick name:
				</label>&nbsp;<input type="text" name="nickName" id="nickName" value="" />
			</div>
			<div id="readyPanel" class="r-panel ui-body-c" data-role="fieldcontain">
				<button id="ready" type="button" data-theme="e">
					Ready
				</button>
				<span>마음의 준비가 되셨으면,
					<br/>
					Ready 버튼을 노란색으로 바꿔주세요
				</span>
			</div>
			<div id="hpPanel" class="r-panel ui-body-b">
				<span id="myNick">azki</span>'s HP: <span id="hp">100</span>
			</div>
			<div id="anglePanel" class="r-panel ui-body-c">
				<h2>Angle</h2>
				<input type="range" name="angleSlider" id="angleSlider" value="45" min="1" max="179" data-highlight="true" />
			</div>
			<div id="powerPanel" class="r-panel ui-body-c">
				<h2>Power</h2>
				<input type="range" name="powerSlider" id="powerSlider" value="50" min="0" max="99" data-highlight="true" />
			</div>
			<div id="btnsPanel" class="r-panel ui-body-c">
				<button id="move" type="button" data-inline="true">
					moving (&infin;)
				</button>
				<button id="doubleShot" type="button" data-inline="true">
					double shot (2/2)
				</button>
				<button id="shot" type="button" data-inline="true">
					normal shot (&infin;)
				</button>
			</div>
		</form>
		<script>
"use strict";
var ROOM_NUM = -1;
window.onload = function() {
	//create client unique key.
	var clientUniq = localStorage.getItem("clientUniq");
	if (!clientUniq) {
		clientUniq = Math.random().toString(36).substr(2);
		localStorage.setItem("clientUniq", clientUniq);
	}
	
	//input nickName
	var nickName = localStorage.getItem("nickName");
	if (!nickName) {
		nickName = prompt("닉네임을 입력하세요", "");
		localStorage.setItem("nickName", nickName);
	}
	$("#nickName").val(nickName);
	
	//init room number.
	(function() {
		var matched = location.href.match(/^\S+\/(\d+)$/);
		if (matched) {
			ROOM_NUM = +matched[1];
		}
	}());
	
	//vars
	var isRoom = false;
	var isMyTurn = false; // TODO.
	var remainDoubleShotCount = 2; // TODO.
	var socket = io4azki.connect("/tank");
	socket.on("connect", function() {
		$("#status").html("접속 중입니다.");
		socket.emit("join", {
			clientUniq: clientUniq,
			nickName: nickName,
			roomNum: ROOM_NUM
		});
	});
	socket.on("disconnect", function() {
		$("#status").html("접속이 끊켰어요..");
		isRoom = false;
	});
	socket.on("okRoom", function(info) {
		$("#status").html(info.roomNum + "번 방에 입장했어요!");
		isRoom = true;
	});
	socket.on("tank_error", function(msg) {
		$("#status").html("Error : " + msg + msg + msg + msg);
		isRoom = false;
	});
	
	function sendAngle() {
		if (isRoom) {
			socket.emit("tank", {
				name: "angle",
				value: Math.abs(180 - $("#angleSlider").val())
			});
		}
	}
	
	function sendPower() {
		if (isRoom) {
			socket.emit("tank", {
				name: "power",
				value: +$("#powerSlider").val()
			});
		}
	}
	
	function sendFire(fireType) {
		if (isRoom) {
			socket.emit("tank", {
				name: "fire",
				value: fireType
			});
		}
	}
	
	$("#angleSlider").change(sendAngle);
	$("#powerSlider").change(sendPower);
	$("#move,#doubleShot,#shot").click(function() {
		sendFire($(this).attr("id"));
	});
	
};
		</script>
	</body>
</html>
