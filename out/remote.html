<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>Simple Tank - azki.org:89</title>
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
		<style type="text/css">
			html, body {
			    margin: 0
			}
			
			body {
			    font-family: Georgia;
			}
			
			.r-panel {
			    margin: 0;
			    text-align: center;
			}
			
			.r-panel h2 {
			    margin: 0 0 0 15px;
			    text-align: left;
			}
			
			#statusPanel {
				padding: 10px;
			}
			#status {
				font-size:larger;
				font-weight:bold;
			}
			
			#readyRoomUi, #gameRoomUi {
				display:none;
			}
			
			#nickNamePanel label {
			    display: inline-block;
			}
			#nickName {
			    width: 40%;
			    display: inline-block;
			}
		</style>
		<script src="http://code.jquery.com/jquery-1.7.1.min.js">
		</script>
		<script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js">
		</script>
		<script src="./js/io.min.js">
		</script>
	</head>
	<body>
		<form onsubmit="return false;">
			<div id="statusPanel" class="r-panel ui-body-a">
				<span id="status">status</span>
			</div>
			<div id="readyRoomUi">
				<div id="nickNamePanel" class="r-panel ui-body-c" data-role="fieldcontain">
					<label for="nickName">
						nick name:
					</label>&nbsp;<input type="text" name="nickName" id="nickName" value="" />
				</div>
				<div id="readyPanel" class="r-panel ui-body-c" data-role="fieldcontain">
					<button id="ready" type="button">
						Ready
					</button>
					<span>마음의 준비가 되셨으면,
						<br/>
						Ready 버튼을 눌러주세요.
					</span>
				</div>
			</div>
			<div id="gameRoomUi">
				<div id="hpPanel" class="r-panel ui-body-b">
					<span id="myNick">azki</span>님의 에너지: <span id="hp">100</span>
				</div>
				<div id="anglePanel" class="r-panel ui-body-c">
					<h2>각도</h2>
					<input type="range" name="angleSlider" id="angleSlider" value="45" min="1" max="179" data-highlight="true" />
				</div>
				<div id="powerPanel" class="r-panel ui-body-c">
					<h2>힘</h2>
					<input type="range" name="powerSlider" id="powerSlider" value="30" min="0" max="99" data-highlight="true" />
				</div>
				<div id="btnsPanel" class="r-panel ui-body-c">
					<button id="doubleShot" type="button" data-inline="true">
						더블샷
					</button>
					더블샷은 <span id="remainDoubleShot">2</span>발 남았습니다.
					<br/>
					<button id="move" type="button" data-inline="true">
						이동 (&infin;)
					</button>
					<button id="shot" type="button" data-inline="true">
						발사 (&infin;)
					</button>
				</div>
			</div>
		</form>
		<script>
"use strict";
var ROOM_NUM = -1;
window.onload = function() {
	//input nickName
	var nickName = localStorage.getItem("nickName");
	if (!nickName) {
		nickName = prompt("닉네임을 입력하세요", "");
		localStorage.setItem("nickName", nickName);
	}
	$("#nickName").val(nickName);
	$("#myNick").text(nickName);
	
	//init room number.
	(function() {
		var matched = location.href.match(/^\S+\/(\d+)$/);
		if (matched) {
			ROOM_NUM = +matched[1];
		}
	}());
	
	function showReadyRoom() {
		$("#gameRoomUi").hide();
		$("#readyRoomUi").show();
	}
	function showGameRoom() {
		$("#readyRoomUi").hide();
		$("#gameRoomUi").show();
	}
	
	//vars
	var isRoom = false;
	var isMyTurn = false;
	var myHp = 100;
	var remainDoubleShotCount = 2;
	var isReady = false;
	var socket = io4azki.connect("/tank");
	socket.on("connect", function() {
		console.log("connect");
		$("#status").html("접속 중입니다...");
		socket.emit("join", {
			nickName: nickName,
			roomNum: ROOM_NUM
		});
	});
	socket.on("disconnect", function() {
		console.log("disconnect");
		$("#status").html("접속이 끊어졌어요ㅠㅠ");
		isRoom = false;
		$("#readyRoomUi").hide();
		$("#gameRoomUi").hide();
	});
	socket.on("successJoin", function() {
		console.log("successJoin");
		$("#status").html(ROOM_NUM + "번 방 대기실");
		isRoom = true;
		sendAngle();
		sendPower();
		showReadyRoom();
	});
	socket.on("tank_error", function(msg) {
		console.log("tank_error", msg);
		$("#status").html('<span style="color:#f44">Error: ' + msg + '</span>');
		isRoom = false;
	});
	socket.on("clear_ready", function() {
		console.log("clear_ready");
		isReady = false;
		$("#ready").css("background-color", isReady ? "yellow" : "");
	});
	socket.on("startGame", function() {
		console.log("startGame");
		$("#status").html("게임이 시작되었습니다.");
		isRoom = true;
		isMyTurn = false;
		myHp = 100;
		remainDoubleShotCount = 2;
		$("#remainDoubleShot").text(remainDoubleShotCount);
		showGameRoom();
	});
	socket.on("waitTurnToMyTurn", function(waitTurn) {
		console.log("waitTurnToMyTurn", waitTurn);
		if (myHp <= 0) {
			$("#status").html("사망하셨습니다.");
			isMyTurn = false;
		} else if (waitTurn === 0) {
			$("#status").html("내 차례입니다.");
			isMyTurn = true;
		} else {
			$("#status").html(waitTurn + "턴 후 차례가 돌아옵니다.");
			isMyTurn = false;
		}
		sendAngle();
		sendPower();
	});
	socket.on("endGame", function() {
		console.log("endGame");
		$("#status").html(ROOM_NUM + "번 방 대기실");
		isRoom = true;
		isMyTurn = false;
		showReadyRoom();
	});
	socket.on("hp", function(hp) {
		console.log("hp", hp);
		myHp = hp;
		if (hp > 0) {
			$("#hp").text(hp);
		} else {
			$("#hp").text("사망하셨습니다.");
		}
	});
	
	function sendAngle() {
		if (isRoom) {
			socket.emit("tank", {
				name: "angle",
				value: Math.abs(180 - $("#angleSlider").val())
			});
		}
	}
	
	function sendPower() {
		if (isRoom) {
			socket.emit("tank", {
				name: "power",
				value: +$("#powerSlider").val()
			});
		}
	}
	
	function sendFire(fireType) {
		if (isRoom) {
			socket.emit("tank", {
				name: "fire",
				value: fireType
			});
			isMyTurn = false;
		}
	}
	
	$("#angleSlider").change(sendAngle);
	$("#powerSlider").change(sendPower);
	$("#move,#shot").click(function() {
		if (isMyTurn === false) {
			return;
		}
		sendFire($(this).attr("id"));
	});
	$("#doubleShot").click(function() {
		if (isMyTurn === false) {
			return;
		}
		if (remainDoubleShotCount > 0) {
			remainDoubleShotCount -= 1;
			$("#remainDoubleShot").text(remainDoubleShotCount);
			sendFire($(this).attr("id"));
		}
	});
	$("#ready").click(function() {
		if (isRoom) {
			isReady = !isReady;
			socket.emit("tank", {
				name: "ready",
				value: isReady
			});
			$(this).css("background-color", isReady ? "yellow" : "");
		}
	})
};
		</script>
	</body>
</html>
